#!/usr/bin/env python3
"""
Master diagnostic command - one command to rule them all

Usage:
    ./check                          # Quick health check both environments
    ./check prod                     # Health check prod only
    ./check status prod              # Recent uploads in prod
    ./check deploy prod              # Full deployment verification
    ./check compare                  # Compare staging vs prod
    ./check fix                      # Show fix commands for all issues

    ./check prod Roku file.csv       # Deep dive on specific upload
"""

import sys
import subprocess
from pathlib import Path

diagnostics_dir = Path(__file__).parent / 'sql' / 'diagnostics'


def run_cmd(cmd):
    """Run a command and return exit code"""
    result = subprocess.run(cmd, shell=True)
    return result.returncode


def main():
    args = sys.argv[1:]

    # No args or just env - quick health
    if not args or (len(args) == 1 and args[0] in ['staging', 'prod']):
        env_arg = f"--env {args[0]}" if args else ""
        return run_cmd(f"python {diagnostics_dir}/health.py {env_arg}")

    # Status command
    if args[0] == 'status':
        if len(args) < 2:
            print("Usage: ./check status [staging|prod]")
            return 1
        return run_cmd(f"python {diagnostics_dir}/status.py --env {args[1]}")

    # Deploy verification
    if args[0] in ['deploy', 'deployment']:
        if len(args) < 2:
            print("Usage: ./check deploy [staging|prod]")
            return 1
        return run_cmd(f"python {diagnostics_dir}/diagnose.py --env {args[1]} --check deployment")

    # Compare
    if args[0] == 'compare':
        return run_cmd(f"python {diagnostics_dir}/compare.py")

    # Fix commands
    if args[0] == 'fix':
        return run_cmd(f"python {diagnostics_dir}/health.py --fix")

    # Deep dive: env platform filename
    if len(args) == 3:
        env, platform, filename = args
        if env not in ['staging', 'prod']:
            print(f"Unknown environment: {env}")
            return 1
        return run_cmd(f"python {diagnostics_dir}/diagnose.py --env {env} --platform {platform} --filename \"{filename}\"")

    # Unknown
    print(f"Unknown command. Usage:")
    print(f"  ./check                      # Quick health")
    print(f"  ./check prod                 # Health check prod")
    print(f"  ./check status prod          # Recent uploads")
    print(f"  ./check deploy prod          # Full verification")
    print(f"  ./check compare              # Staging vs prod")
    print(f"  ./check fix                  # Show fixes")
    print(f"  ./check prod Roku file.csv   # Deep dive")
    return 1


if __name__ == '__main__':
    sys.exit(main())
