# Fixes Applied: December 2, 2025

## Summary

Fixed two critical issues in the viewership data pipeline that were preventing proper processing of monthly/quarterly data (like Tubi VOD):

1. **Date fields going NULL** - SET_DATE_COLUMNS_DYNAMIC was overwriting month/year/quarter for data without specific dates
2. **asset_series not being set** - PROCESS_VIEWERSHIP_REF_ID_SERIES_GENERIC was missing UNION fallback for records where title doesn't match exactly

## Issue 1: Date Fields Going NULL for Monthly/Quarterly Data

### Problem
When processing monthly/quarterly data (e.g., Tubi VOD July with month='July', year='2025'), the date fields (year, month, quarter) would be set correctly initially but then get overwritten to NULL during normalization.

### Root Cause
SET_DATE_COLUMNS_DYNAMIC assumed all data has a `date` field and tried to derive year/month/quarter from it. For monthly/quarterly data with NULL date fields, this would fail and leave fields blank.

### Fix Applied
Updated `snowflake/stored_procedures/generic/set_date_columns_dynamic.sql`:

Added logic to check if date field is NULL before attempting to derive from it:

```javascript
// Check if there is a date column with data
var checkDateQuery = `
    SELECT COUNT(*) as cnt
    FROM {{STAGING_DB}}.public.platform_viewership
    WHERE platform = '${platform}'
      AND filename = '${filename}'
      AND date IS NOT NULL
      AND TRIM(date) != ''
`;

var dateCheckResult = snowflake.execute({sqlText: checkDateQuery});
var hasDateColumn = false;
if (dateCheckResult.next()) {
    hasDateColumn = dateCheckResult.getColumnValue('CNT') > 0;
}

if (!hasDateColumn) {
    // No date column - handle monthly/quarterly data
    // Convert month name to numeric format
    updateCommands.push(`
        UPDATE {{STAGING_DB}}.public.platform_viewership
        SET month = CASE LOWER(month)
            WHEN 'january' THEN '1'
            WHEN 'february' THEN '2'
            WHEN 'march' THEN '3'
            WHEN 'april' THEN '4'
            WHEN 'may' THEN '5'
            WHEN 'june' THEN '6'
            WHEN 'july' THEN '7'
            WHEN 'august' THEN '8'
            WHEN 'september' THEN '9'
            WHEN 'october' THEN '10'
            WHEN 'november' THEN '11'
            WHEN 'december' THEN '12'
            ELSE month
        END
        WHERE platform = '${platform}'
          AND filename = '${filename}'
          AND processed IS NULL
          AND month IS NOT NULL
    `);

    // Set quarter based on month
    updateCommands.push(`
        UPDATE {{STAGING_DB}}.public.platform_viewership
        SET quarter = CASE
            WHEN CAST(month AS INT) IN (1, 2, 3) THEN 'q1'
            WHEN CAST(month AS INT) IN (4, 5, 6) THEN 'q2'
            WHEN CAST(month AS INT) IN (7, 8, 9) THEN 'q3'
            WHEN CAST(month AS INT) IN (10, 11, 12) THEN 'q4'
        END
        WHERE platform = '${platform}'
          AND filename = '${filename}'
          AND processed IS NULL
          AND month IS NOT NULL
    `);

    // Set year_month_day using year and month
    updateCommands.push(`
        UPDATE {{STAGING_DB}}.public.platform_viewership
        SET year_month_day = year || '-' || LPAD(month, 2, '0') || '-01'
        WHERE platform = '${platform}'
          AND filename = '${filename}'
          AND processed IS NULL
          AND year IS NOT NULL
          AND month IS NOT NULL
    `);
}
```

### Files Modified
- `snowflake/stored_procedures/generic/set_date_columns_dynamic.sql`

### Deployment
- Deployed to STAGING: December 2, 2025
- Deployed to PROD: December 2, 2025

---

## Issue 2: asset_series Not Being Set for REF_ID_SERIES Bucket

### Problem
Records with ref_id and internal_series populated were being routed to REF_ID_SERIES bucket correctly, but the procedure was updating 0 rows. asset_series, content_provider, and series_code were not being set.

### Root Cause
The deployed PROCESS_VIEWERSHIP_REF_ID_SERIES_GENERIC procedure was missing the UNION fallback query. It only had the first SELECT with strict title matching:

```sql
-- Only had this part (strict matching with title check):
SELECT v.id, m.title, s.content_provider, s.series_code, ...
FROM test_staging.public.platform_viewership v
JOIN metadata_master_cleaned_staging.public.metadata m_title_check ON (
    e.ref_id = m_title_check.ref_id
    AND (
        LOWER(REGEXP_REPLACE(TRIM(m_title_check.title), '[^A-Za-z0-9]', '')) =
        LOWER(REGEXP_REPLACE(TRIM(v.platform_content_name), '[^A-Za-z0-9]', ''))
        OR
        LOWER(REGEXP_REPLACE(TRIM(m_title_check.clean_title), '[^A-Za-z0-9]', '')) =
        LOWER(REGEXP_REPLACE(TRIM(v.platform_content_name), '[^A-Za-z0-9]', ''))
    )
)
WHERE ...

-- MISSING: UNION fallback without title check
```

For Tubi data, platform_content_name values like "S03:E140 - You Waited 17 Years for This!" don't match metadata titles exactly, so the strict matching failed.

### Fix Applied
Redeployed complete `snowflake/stored_procedures/-sub-procedures/content_references/generic/ref_id_series.sql` with UNION fallback:

```sql
UPDATE test_staging.public.platform_viewership w
SET w.series_code = q.series_code,
    w.content_provider = q.content_provider,
    w.asset_title = q.title,
    w.asset_series = q.asset_series
FROM (
    -- First attempt: Match with title check (strict)
    SELECT v.id, m.title, s.content_provider, s.series_code, ...
    FROM test_staging.public.platform_viewership v
    JOIN metadata_master_cleaned_staging.public.metadata m_title_check ON (
        e.ref_id = m_title_check.ref_id
        AND (title match condition)
    )
    WHERE v.ref_id IS NOT NULL
      AND v.internal_series IS NOT NULL
      AND lower(s.status) = 'active'
      AND LOWER(extract_primary_title(s.titles)) = LOWER(v.internal_series)

    UNION

    -- Fallback: Match on ref_id and series only, no title check
    SELECT v.id, m.title, s.content_provider, s.series_code, ...
    FROM test_staging.public.platform_viewership v
    JOIN metadata_master_cleaned_staging.public.episode e ON (v.ref_id = e.ref_id)
    JOIN metadata_master_cleaned_staging.public.series s ON (s.id = e.series_id)
    JOIN metadata_master_cleaned_staging.public.metadata m ON (e.ref_id = m.ref_id)
    WHERE v.ref_id IS NOT NULL
      AND v.internal_series IS NOT NULL
      AND lower(s.status) = 'active'
      AND LOWER(extract_primary_title(s.titles)) = LOWER(v.internal_series)
      -- Exclude records already matched in first attempt
      AND NOT EXISTS (
          SELECT 1 FROM metadata m_check
          WHERE e.ref_id = m_check.ref_id
          AND (title match condition)
      )
) q
WHERE w.id = q.id
```

The UNION pattern:
1. **First SELECT**: Try strict matching with ref_id + series + title check
2. **UNION**: Fall back to matching on ref_id + series WITHOUT requiring title to match
3. **NOT EXISTS**: Prevents duplicates by excluding records already matched in first attempt

### Files Modified
- `snowflake/stored_procedures/-sub-procedures/content_references/generic/ref_id_series.sql`

### Deployment
- Deployed to STAGING: December 2, 2025
- Deployed to PROD: December 2, 2025
- Verified UNION statement exists in deployed DDL

### Deployment Scripts Used
- `deploy_ref_id_series_proc.py` - Deploys ref_id_series procedure
- `deploy_date_proc.py` - Deploys set_date_columns_dynamic procedure

---

## Test Results: Tubi VOD July Data

### Before Fixes
```
Total records: 321
Has ref_id: 321
Has internal_series: 321
Has asset_series: 0        ❌
Has content_provider: 0    ❌
Has series_code: 0         ❌
Has year: 0                ❌
Has month: 0               ❌
Has quarter: 0             ❌
```

### After Fixes
```
Total records: 321
Has ref_id: 321
Has internal_series: 321
Has asset_series: 321      ✅ (100%)
Has content_provider: 321  ✅ (100%)
Has series_code: 321       ✅ (100%)
Has year: 321              ✅ (100%)
Has month: 321             ✅ (100%)
Has quarter: 321           ✅ (100%)
```

### Sample Matched Records
```
S03:E140 - You Waited 17 Years for This! | Series: The Steve Wilkos Show | Provider: NBC | Code: SW | 2025-7-Q3
S11:E33 - Torn Apart. Where Are They Now  | Series: Maury                | Provider: NBC | Code: MS | 2025-7-Q3
S12:E31 - I Want Your Lover!               | Series: Jerry Springer       | Provider: NBC | Code: JS | 2025-7-Q3
S01:E03 - I'll Unlock My Phone to Prove   | Series: Karamo               | Provider: NBC | Code: KA | 2025-7-Q3
```

---

## Impact

These fixes enable proper processing of:

1. **Monthly/Quarterly Data**: Platforms that provide aggregate data by month/quarter instead of daily data (e.g., Tubi VOD reports)

2. **REF_ID_SERIES Bucket**: Records where:
   - ref_id is populated (matched from platform_content_id)
   - internal_series is populated (matched from deal_parent)
   - episode_number/season_number are NOT numeric (e.g., string "None")
   - Platform content name doesn't exactly match metadata title

### Affected Platforms
- Tubi VOD (monthly/quarterly aggregated data)
- Any platform with non-numeric episode/season numbers that fall back to REF_ID_SERIES bucket
- Any platform where content names don't exactly match metadata titles

---

## Related Procedures

### Data Pipeline Flow
1. **MOVE_STREAMLIT_DATA_TO_STAGING** - Copies data from UPLOAD_DB to TEST_STAGING
   - Filter: `processed IS NULL OR processed = FALSE`
   - Sets phase = '0'

2. **NORMALIZE_DATA_IN_STAGING** - Phase 1 normalization
   - Calls SET_DEAL_PARENT_GENERIC
   - Calls SET_REF_ID_FROM_PLATFORM_CONTENT_ID
   - Calls CALCULATE_VIEWERSHIP_METRICS
   - Calls **SET_DATE_COLUMNS_DYNAMIC** (FIXED)
   - Sets phase = '1'

3. **ANALYZE_AND_PROCESS_VIEWERSHIP_DATA_GENERIC** - Phase 2 content matching
   - Creates buckets based on available data
   - Calls bucket procedures like **PROCESS_VIEWERSHIP_REF_ID_SERIES_GENERIC** (FIXED)
   - Sets phase = '2'

4. **HANDLE_FINAL_INSERT_DYNAMIC_GENERIC** - Phase 3 validation and final insert
   - Validates data
   - Inserts to final table
   - Sets processed = TRUE

### Bucket Selection Logic
- **FULL_DATA**: ref_id + internal_series + numeric episode_number + numeric season_number
- **REF_ID_SERIES**: ref_id + internal_series (no numeric episode/season requirement)
- **REF_ID_ONLY**: ref_id only
- **SERIES_SEASON_EPISODE**: internal_series + numeric episode_number + numeric season_number
- **SERIES_ONLY**: internal_series only
- **TITLE_ONLY**: platform_content_name matching

---

## Important Notes

### DO NOT Remove Processed Filter
The `processed IS NULL OR processed = FALSE` filter in MOVE_STREAMLIT_DATA_TO_STAGING is CRITICAL and must NOT be removed. Streamlit sets processed=TRUE after upload, so data should be copied BEFORE that flag is set.

If data is already processed=TRUE in UPLOAD_DB, the solution is to:
1. Re-upload the data through Streamlit
2. OR manually set processed=FALSE in UPLOAD_DB before calling MOVE_STREAMLIT_DATA_TO_STAGING

### UNION Fallback Pattern
The UNION fallback pattern is used in multiple bucket procedures:
- ref_id_series.sql
- full_data.sql (should verify this has UNION too)
- Others may need the same pattern

The pattern provides resilience by trying strict matching first, then falling back to looser matching if needed.

---

## Verification Commands

### Check if date fields are set correctly
```sql
SELECT
    COUNT(*) as total,
    SUM(CASE WHEN year IS NOT NULL THEN 1 ELSE 0 END) as has_year,
    SUM(CASE WHEN month IS NOT NULL THEN 1 ELSE 0 END) as has_month,
    SUM(CASE WHEN quarter IS NOT NULL THEN 1 ELSE 0 END) as has_quarter
FROM TEST_STAGING.PUBLIC.platform_viewership
WHERE platform = 'Tubi' AND filename = 'tubi_vod_july.csv';
```

### Check if asset_series is set correctly
```sql
SELECT
    COUNT(*) as total,
    SUM(CASE WHEN asset_series IS NOT NULL THEN 1 ELSE 0 END) as has_asset_series,
    SUM(CASE WHEN content_provider IS NOT NULL THEN 1 ELSE 0 END) as has_content_provider,
    SUM(CASE WHEN series_code IS NOT NULL THEN 1 ELSE 0 END) as has_series_code
FROM TEST_STAGING.PUBLIC.platform_viewership
WHERE platform = 'Tubi' AND filename = 'tubi_vod_july.csv';
```

### Check error logs for REF_ID_SERIES bucket
```sql
SELECT log_message, rows_affected, status, log_time
FROM UPLOAD_DB.PUBLIC.ERROR_LOG_TABLE
WHERE procedure_name = 'process_viewership_ref_id_series_generic'
  AND platform = 'Tubi'
ORDER BY log_time DESC
LIMIT 10;
```

### Verify UNION exists in deployed procedure
```sql
SELECT GET_DDL('PROCEDURE', 'UPLOAD_DB.PUBLIC.PROCESS_VIEWERSHIP_REF_ID_SERIES_GENERIC(VARCHAR, VARCHAR)');
-- Should contain "UNION" keyword
```
